<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Redirecionando...</title>

  <!-- Pixel Meta base -->
  <script>
  !function(f,b,e,v,n,t,s){if(f.fbq)return;n=f.fbq=function(){
  n.callMethod? n.callMethod.apply(n,arguments):n.queue.push(arguments)};
  if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
  n.queue=[];t=b.createElement(e);t.async=!0;
  t.src=v;s=b.getElementsByTagName(e)[0];
  s.parentNode.insertBefore(t,s)}(window, document,'script',
  'https://connect.facebook.net/en_US/fbevents.js');

  fbq('init', '1465089154541888'); /* seu Pixel */
  fbq('track', 'PageView');
  </script>
  <noscript>
    <img height="1" width="1" style="display:none"
         src="https://www.facebook.com/tr?id=1465089154541888&ev=PageView&noscript=1"/>
  </noscript>

  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif;
         text-align:center; margin-top:64px}
  </style>
</head>
<body>
  <p>Redirecionando para o WhatsApp...</p>

  <script>
    // ============== CONFIG ====================
    const WHATSAPP_NUMBER = '5535991712235'; // seu n√∫mero destino
    const BASE_MESSAGE    = 'Ol√°! Quero receber os materiais!'; // mensagem vis√≠vel

    // ADAPTADO PARA VERCEL: use o seu webhook aqui (sem preflight CORS)
    // const PREHOOK_URL  = 'https://n8n.granapdf.com/webhook/redirect'; // antigo
    const PREHOOK_URL     = 'https://webhook.servidorrrdigital.site/webhook/redirect'; // novo

    const REDIRECT_DELAY  = 3000; // ms
    const DEDUPE_TTL_MS   = 5 * 60 * 1000; // 5 min

    // ============== HELPERS ===================
    const qp = (n)=> new URLSearchParams(location.search).get(n);
    function getCookie(k){
      const v = `; ${document.cookie}`.split(`; ${k}=`); return v.length === 2 ? v.pop().split(';').shift() : null;
    }
    function uuidv4(){
      return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g,c=>{
        const r = crypto.getRandomValues(new Uint8Array(1))[0] & 15;
        const v = c === 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
      });
    }
    function setDedupe(id){ try{ localStorage.setItem(`redir_sent_${id}`, String(Date.now())); }catch{} }
    function isDedupe(id){
      try{
        const t = Number(localStorage.getItem(`redir_sent_${id}`) || 0);
        return t && (Date.now() - t) < DEDUPE_TTL_MS;
      }catch{}
      return false;
    }
    function slug(s){ return String(s||'na').toLowerCase().replace(/[^a-z0-9]+/g,'_').replace(/^_|_$/g,''); }

    // --------- Zero-width encoder (hex -> invis√≠vel) ----------
    function encodeHexAsInvis(hex) {
      const MAP = {
        '0': '\u200B', '1': '\u200C', '2': '\u200D', '3': '\u2060',
        '4': '\u061C', '5': '\u180D', '6': '\u034F', '7': '\u00AD',
        '8': '\u17B4', '9': '\u115F', 'a': '\u2061', 'b': '\u2062',
        'c': '\u2063', 'd': '\u2064', 'e': '\u206A', 'f': '\u206F'
      };
      return hex.toLowerCase().replace(/[^0-9a-f]/g, '').slice(0, 12).split('').map(char => {
        return MAP[char] ? MAP[char].replace('\\u', '\u') : '';
      }).join('');
    }

    // Fun√ß√£o de teste para verificar compatibilidade
    function testInvisibleToken() {
      const testHex = 'abc123def456';
      const invisibleToken = encodeHexAsInvis(testHex);
      const isAndroid = /Android/i.test(navigator.userAgent);
      const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
      const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
      console.log('üß™ TESTE INVIS√çVEL', { testHex, invisibleToken, isAndroid, isIOS, isMobile });
    }

    // ============== IP & LOCATION HELPERS (mantidos) ======================
    let userIP = 'unknown';
    let userLocation = { country: 'BR', city: 'unknown', state: 'unknown' };

    const IP_APIS = [
      'https://api.ipify.org?format=json',
      'https://api64.ipify.org?format=json',
      'https://api.myip.com',
      'https://ipinfo.io/json',
      'https://httpbin.org/ip',
      'https://icanhazip.com',
      'https://checkip.amazonaws.com',
      'https://wtfismyip.com/json'
    ];

    async function getIPAndLocation() {
      for (let i = 0; i < IP_APIS.length; i++) {
        try {
          const ipResponse = await fetch(IP_APIS[i], { method: 'GET' });
          if (ipResponse.ok) {
            const ipData = await ipResponse.json().catch(()=>({}));
            const detectedIP = ipData.ip || ipData.ipAddress || ipData.query || ipData.ip_addr || null;
            if (detectedIP) { userIP = detectedIP; break; }
          }
        } catch {}
      }
    }
    getIPAndLocation();
    testInvisibleToken();

    function getBrowserInfo() {
      const ua = navigator.userAgent;
      if (ua.includes('Chrome')) return 'Chrome';
      if (ua.includes('Firefox')) return 'Firefox';
      if (ua.includes('Safari')) return 'Safari';
      if (ua.includes('Edge')) return 'Edge';
      if (ua.includes('Opera')) return 'Opera';
      return 'Unknown';
    }
    function getBrowserVersion() {
      const ua = navigator.userAgent;
      const browser = getBrowserInfo();
      if (browser === 'Chrome')  { const m = ua.match(/Chrome\/(\d+)/); return m?m[1]:'Unknown'; }
      if (browser === 'Firefox') { const m = ua.match(/Firefox\/(\d+)/); return m?m[1]:'Unknown'; }
      if (browser === 'Safari')  { const m = ua.match(/Version\/(\d+)/); return m?m[1]:'Unknown'; }
      if (browser === 'Edge')    { const m = ua.match(/Edg\/(\d+)/); return m?m[1]:'Unknown'; }
      return 'Unknown';
    }
    function getOSInfo() {
      const ua = navigator.userAgent;
      if (ua.includes('Windows')) return 'Windows';
      if (ua.includes('Mac')) return 'macOS';
      if (ua.includes('Linux')) return 'Linux';
      if (ua.includes('Android')) return 'Android';
      if (ua.includes('iOS')) return 'iOS';
      return 'Unknown';
    }
    function getOSVersion() {
      const ua = navigator.userAgent;
      if (ua.includes('Windows')) { if (ua.includes('Windows NT 10.0')) return '10.0'; return 'Unknown'; }
      if (ua.includes('Mac'))     { const m = ua.match(/Mac OS X (\d+_\d+)/); return m?m[1].replace('_','.'): 'Unknown'; }
      if (ua.includes('Android')) { const m = ua.match(/Android (\d+)/); return m?m[1]:'Unknown'; }
      if (ua.includes('iOS'))     { const m = ua.match(/OS (\d+_\d+)/); return m?m[1].replace('_','.'): 'Unknown'; }
      return 'Unknown';
    }
    function getDeviceModel() {
      const ua = navigator.userAgent;
      if (ua.includes('Mobile')) { if (ua.includes('iPhone')) return 'iPhone'; if (ua.includes('iPad')) return 'iPad'; return 'Android Mobile'; }
      return 'Desktop';
    }

    // ============== WEBHOOK (ADAPTADO P/ VERCEL) ======================
    async function sendWebhook(payload) {
      try {
        // 1) Tenta sendBeacon com 'application/x-www-form-urlencoded' (sem preflight)
        const params = new URLSearchParams();
        Object.entries(payload).forEach(([k, v]) => {
          if (v !== null && v !== undefined) {
            params.append(k, typeof v === 'object' ? JSON.stringify(v) : String(v));
          }
        });
        const body = params.toString();
        const beaconBlob = new Blob([body], { type: 'application/x-www-form-urlencoded; charset=UTF-8' });
        const beaconOk = navigator.sendBeacon(PREHOOK_URL, beaconBlob);
        if (beaconOk) {
          console.log('‚úÖ Webhook enviado via sendBeacon (no-CORS)');
          return true;
        }

        // 2) Fallback: fetch "simple request" (sem headers custom => sem preflight)
        const resp = await fetch(PREHOOK_URL, {
          method: 'POST',
          mode: 'cors',
          keepalive: true,
          headers: { 'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8' },
          body
        });
        if (resp.ok) {
          console.log('‚úÖ Webhook enviado via fetch x-www-form-urlencoded');
          return true;
        }
        console.warn('‚ö†Ô∏è Fallback fetch falhou:', resp.status);
        return false;
      } catch (e) {
        console.error('‚ùå Erro ao enviar webhook:', e);
        return false;
      }
    }

    // ============== FLOW ======================
    setTimeout(async function(){
      // UTMs
      const utm_source   = slug(qp('utm_source')   || 'organic');
      const utm_medium   = slug(qp('utm_medium')   || 'direct');
      const utm_campaign = slug(qp('utm_campaign') || 'na');
      const utm_content  = slug(qp('utm_content')  || 'na');
      const utm_term     = slug(qp('utm_term')     || 'na');

      // Meta cookies/params
      const fbp    = getCookie('_fbp') || 'na';
      const fbclid = qp('fbclid');
      const fbc    = fbclid ? `fb.1.${Date.now()}.${fbclid}` : 'na';

      const event_id = uuidv4();
      const tokenHex = event_id.replace(/-/g,'').slice(0,12);
      const hiddenToken = encodeHexAsInvis(tokenHex);
      const mensagem = `${BASE_MESSAGE}${hiddenToken}`;

      if (!isDedupe(event_id)) setDedupe(event_id);

      const payload = {
        event_type: 'lead_captured',
        event_id,
        short_token: tokenHex,
        link_id: `${utm_source}_${utm_medium}_${utm_campaign}`,
        phone_target: WHATSAPP_NUMBER,
        utm_source, utm_medium, utm_campaign, utm_content, utm_term,
        ad_id: utm_content !== 'na' ? utm_content : null,
        adset_id: utm_campaign !== 'na' ? utm_campaign : null,
        campaign_id: utm_campaign !== 'na' ? utm_campaign : null,
        url: location.href,
        referrer: document.referrer || null,
        user_agent: navigator.userAgent,
        language: navigator.language || 'pt-BR',
        timezone: Intl.DateTimeFormat().resolvedOptions().timeZone || 'UTC',
        screen: `${screen?.width || 0}x${screen?.height || 0}`,
        device_model: getDeviceModel(),
        browser_name: getBrowserInfo(),
        browser_version: getBrowserVersion(),
        os_name: getOSInfo(),
        os_version: getOSVersion(),
        ip: userIP !== 'unknown' ? userIP : null,
        city: userLocation.city || null,
        region: userLocation.region || null,
        country: userLocation.country || null,
        country_code: userLocation.country || null,
        fbp: fbp !== 'na' ? fbp : null,
        fbc: fbc !== 'na' ? fbc : null,
        fbclid: fbclid || null,
        client_timestamp: new Date().toISOString()
      };

      // Envia webhook sem bloquear o redirect
      sendWebhook(payload);

      // Pixel Lead (inalterado no conceito)
      try { 
        if (fbq) {
          const pixelPayload = {
            value: 0, currency: 'BRL',
            fbc: fbc !== 'na' ? fbc : undefined,
            fbp: fbp !== 'na' ? fbp : undefined,
            user_agent: navigator.userAgent
          };
          if (userIP !== 'unknown') pixelPayload.ip_address = userIP;
          if (utm_source !== 'organic') pixelPayload.utm_source = utm_source;
          if (utm_medium !== 'direct')  pixelPayload.utm_medium = utm_medium;
          if (utm_campaign !== 'na')   { pixelPayload.campaign_id = utm_campaign; pixelPayload.utm_campaign = utm_campaign; }
          if (utm_content  !== 'na')   { pixelPayload.content_name = utm_content; pixelPayload.ad_id = utm_content; pixelPayload.utm_content = utm_content; }
          if (utm_term     !== 'na')    pixelPayload.utm_term = utm_term;
          pixelPayload.page_title = document.title;
          pixelPayload.page_url   = location.href;
          pixelPayload.referrer   = document.referrer || undefined;
          fbq('track', 'Lead', pixelPayload, { eventID: event_id, eventSourceUrl: location.href });
        }
      } catch {}

      // Redirect para WhatsApp
      const waUrl = `https://api.whatsapp.com/send?phone=${encodeURIComponent(WHATSAPP_NUMBER)}&text=${encodeURIComponent(mensagem)}`;
      window.location.replace(waUrl);
    }, REDIRECT_DELAY);
  </script>
</body>
</html>
