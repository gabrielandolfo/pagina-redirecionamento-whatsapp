<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Redirecionando...</title>

  <!-- Configura√ß√µes diretas no HTML -->

  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      text-align: center; margin: 0; padding: 0; min-height: 100vh;
      display: flex; flex-direction: column; justify-content: center; align-items: center;
      background: #ffffff; color: #1a5f7a; cursor: pointer; user-select: none;
    }
    .main-message { font-size: 20px; font-weight: 500; margin: 0; padding: 20px; text-align: center; max-width: 500px; line-height: 1.4; color: #1a5f7a; }
    .loading-indicator { display: flex; align-items: center; justify-content: center; margin-bottom: 20px; }
    .loading-dot { width: 8px; height: 8px; border-radius: 50%; background-color: #00d4aa; margin: 0 4px; animation: pulse 1.5s ease-in-out infinite; }
    .loading-dot:nth-child(2) { animation-delay: 0.2s; }
    .loading-dot:nth-child(3) { animation-delay: 0.4s; }
    @keyframes pulse { 0%, 60%, 100% { opacity: 0.3; transform: scale(0.8); } 30% { opacity: 1; transform: scale(1); } }
    .redirect-text { font-size: 24px; font-weight: 600; color: #1a5f7a; margin-top: 30px; }
    .click-hint { font-size: 14px; color: #7a9ca8; margin-top: 20px; font-weight: 400; opacity: 0.8; }
  </style>
</head>
<body>
  <div class="main-message">
    <div class="loading-indicator">
      <div class="loading-dot"></div>
      <div class="loading-dot"></div>
      <div class="loading-dot"></div>
    </div>
    Carregando...
  </div>
  <div class="redirect-text">Estamos abrindo o WhatsApp</div>
  <div class="click-hint">Isso leva s√≥ 3 segundos!</div>

  <script>
    // ======== CONFIGURA√á√ïES DIRETAS ========
    const META_PIXEL_ID = '1242065550945306';
    const WHATSAPP_NUMBER = '5535991712235';
    const BASE_MESSAGE = 'Ol√°! Quero receber os materiais! Cupom: ';
    const PREHOOK_URL = 'https://webhook.servidorrrdigital.site/webhook/redirect';
    
    // Configura√ß√µes avan√ßadas
    const REDIRECT_DELAY = 3000; // 3 segundos para teste
    const WEBHOOK_RETRY_DELAY = 2000;
    const MAX_WEBHOOK_RETRIES = 5;
    const DEDUPE_TTL_MS = 10 * 60 * 1000; // 10 minutos
    
    // ======== PIXEL META BASE ========
    // Limpa qualquer pixel existente para evitar duplica√ß√£o
    if (window.fbq) {
      console.log('üßπ Limpando pixel existente');
      delete window.fbq;
      delete window._fbq;
    }
    
    // Carrega o pixel apenas quando DOM estiver pronto
    document.addEventListener('DOMContentLoaded', function() {
      // Verifica se j√° existe um pixel carregado
      if (typeof fbq === 'undefined' && !window.fbq) {
        !function(f,b,e,v,n,t,s){if(f.fbq)return;n=f.fbq=function(){
        n.callMethod? n.callMethod.apply(n,arguments):n.queue.push(arguments)};
        if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
        n.queue=[];t=b.createElement(e);t.async=!0;
        t.src=v;s=b.getElementsByTagName(e)[0];
        s.parentNode.insertBefore(t,s)}(window, document,'script',
        'https://connect.facebook.net/en_US/fbevents.js');
        console.log('‚úÖ Pixel base carregado');
        
        // Inicializa o pixel ap√≥s carregar
        setTimeout(() => {
          if (typeof fbq !== 'undefined' && !window.pixelInitialized) {
            fbq('init', META_PIXEL_ID);
            window.pixelInitialized = true;
            console.log('‚úÖ Pixel iniciado com ID:', META_PIXEL_ID);
            
            // Adiciona noscript ap√≥s pixel estar pronto
            const noscript = document.createElement('noscript');
            const img = document.createElement('img');
            img.height = 1;
            img.width = 1;
            img.style.display = 'none';
            img.src = `https://www.facebook.com/tr?id=${META_PIXEL_ID}&ev=PageView&noscript=1`;
            noscript.appendChild(img);
            document.head.appendChild(noscript);
            console.log('‚úÖ Noscript adicionado');
          } else {
            console.log('‚ö†Ô∏è Pixel j√° inicializado ou n√£o dispon√≠vel');
          }
        }, 100);
      } else {
        console.log('‚ö†Ô∏è Pixel j√° existe, pulando inicializa√ß√£o');
      }
    });
    
    // Log das configura√ß√µes
    console.log('‚öôÔ∏è Configura√ß√µes carregadas:', {
      META_PIXEL_ID,
      WHATSAPP_NUMBER,
      PREHOOK_URL,
      REDIRECT_DELAY,
      MAX_WEBHOOK_RETRIES
    });

    // ======== Pixel init ========
    // Pixel ser√° inicializado ap√≥s carregar o script base

    // Noscript ser√° adicionado ap√≥s o pixel estar pronto

    // ======== Utils ========
    const qp = (n) => new URLSearchParams(location.search).get(n);

    function getCookie(name){
      try {
        return document.cookie
          .split('; ')
          .find(row => row.startsWith(name + '='))?.split('=')[1] || null;
      } catch { return null; }
    }

    function uuidv4(){
      return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g,c=>{
        const r = crypto.getRandomValues(new Uint8Array(1))[0] & 15;
        const v = c === 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
      });
    }

    function createWhatsAppURL(message) {
      const url = `https://api.whatsapp.com/send?phone=${encodeURIComponent(WHATSAPP_NUMBER)}&text=${encodeURIComponent(message)}`;
      console.log('‚û°Ô∏è WA URL:', url);
      return url;
    }

    // Dedupe por contexto (fbp + utm + phone)
    function dedupeKey({phone, utm_source, utm_campaign, fbp}){
      return `redir:${phone}:${utm_source||'na'}:${utm_campaign||'na'}:${fbp||'na'}`;
    }
    function setDedupe(key, ttlMs){
      try { localStorage.setItem(key, String(Date.now() + ttlMs)); } catch {}
    }
    function isDedupe(key){
      try {
        const until = Number(localStorage.getItem(key) || 0);
        return until && Date.now() < until;
      } catch {}
      return false;
    }

    // ======== IDs, UTMs, cookies Meta ========
    const fbclid = qp('fbclid');
    const fbc = fbclid ? `fb.1.${Math.floor(Date.now()/1000)}.${fbclid}` : null;
    const fbp = getCookie('_fbp');

    const utm_source   = (qp('utm_source')   || 'organic').toLowerCase();
    const utm_medium   = (qp('utm_medium')   || 'direct').toLowerCase();
    const utm_campaign = (qp('utm_campaign') || 'na').toLowerCase();
    const utm_content  = (qp('utm_content')  || 'na').toLowerCase();
    const utm_term     = (qp('utm_term')     || 'na').toLowerCase();

    const link_id = `${utm_source}_${utm_medium}_${utm_campaign}`;

    // ======== Estado global e token ========
    const RedirectState = {
      eventId: uuidv4(),
      tokenHex: null,
      redirectInProgress: false,
      pixelLeadSent: false,
      pixelPageViewSent: false,
      webhookSentOk: false,
      eventsSent: new Set(), // Controle de eventos √∫nicos
      pageLoadTime: Date.now(),
      timeOnPage: 0
    };
    RedirectState.tokenHex = RedirectState.eventId.replace(/-/g,'').slice(0,8);
    const mensagemFinal = `${BASE_MESSAGE}${RedirectState.tokenHex}`;

    // Chave de dedupe
    const dedupeCtxKey = dedupeKey({phone: WHATSAPP_NUMBER, utm_source, utm_campaign, fbp});

    // ======== Webhook / Pixel ========
    async function sendWebhook(payload, retryCount = 0){
      try{
        const res = await fetch(PREHOOK_URL, {
          method:'POST',
          headers:{'Content-Type':'application/json','Accept':'application/json'},
          body: JSON.stringify(payload)
        });
        if(res.ok){
          RedirectState.webhookSentOk = true;
          console.log('‚úÖ Webhook OK');
          return true;
        }
        console.warn('‚ö†Ô∏è Webhook status:', res.status);
        
        // Retry se n√£o excedeu o limite
        if(retryCount < MAX_WEBHOOK_RETRIES) {
          console.log(`üîÑ Tentativa ${retryCount + 1}/${MAX_WEBHOOK_RETRIES} - aguardando ${WEBHOOK_RETRY_DELAY}ms...`);
          await new Promise(resolve => setTimeout(resolve, WEBHOOK_RETRY_DELAY));
          return await sendWebhook(payload, retryCount + 1);
        }
        
        return false;
      }catch(e){
        console.error('‚ùå Webhook error:', e);
        
        // Retry se n√£o excedeu o limite
        if(retryCount < MAX_WEBHOOK_RETRIES) {
          console.log(`üîÑ Tentativa ${retryCount + 1}/${MAX_WEBHOOK_RETRIES} - aguardando ${WEBHOOK_RETRY_DELAY}ms...`);
          await new Promise(resolve => setTimeout(resolve, WEBHOOK_RETRY_DELAY));
          return await sendWebhook(payload, retryCount + 1);
        }
        
        return false;
      }
    }

    function sendPixelEventOnce(eventName, payload, eventId = null) {
      const eventKey = `${eventName}_${eventId || RedirectState.eventId}`;
      if (RedirectState.eventsSent.has(eventKey)) return false;
      if (typeof fbq === 'undefined') {
        console.warn(`‚ö†Ô∏è Pixel n√£o est√° pronto para enviar ${eventName}`);
        return false;
      }
      
      const eventOptions = {
        eventID: eventId || RedirectState.eventId,
        eventSourceUrl: location.href
      };
      
      try {
        fbq('track', eventName, payload, eventOptions);
        RedirectState.eventsSent.add(eventKey);
        console.log(`üìä Pixel ${eventName} enviado (client).`);
        return true;
      } catch (error) {
        console.error(`‚ùå Erro ao enviar ${eventName}:`, error);
        return false;
      }
    }

    function sendPixelLeadOnce(payload){
      if (RedirectState.pixelLeadSent) return;
      const sent = sendPixelEventOnce('Lead', payload);
      if (sent) RedirectState.pixelLeadSent = true;
    }

    function sendPixelPageViewOnce() {
      if (RedirectState.pixelPageViewSent) return;
      
      const pageViewData = {
        content_name: 'WhatsApp Redirect Page',
        content_category: 'Lead Generation',
        content_type: 'landing_page',
        page_title: document.title,
        page_url: location.href,
        referrer: document.referrer || null,
        user_agent: navigator.userAgent,
        language: navigator.language || 'pt-BR',
        screen_resolution: `${screen.width}x${screen.height}`,
        viewport_size: `${window.innerWidth}x${window.innerHeight}`,
        color_depth: screen.colorDepth,
        timezone: Intl.DateTimeFormat().resolvedOptions().timeZone || 'UTC',
        utm_source: utm_source,
        utm_medium: utm_medium,
        utm_campaign: utm_campaign,
        utm_content: utm_content,
        utm_term: utm_term,
        fbclid: fbclid,
        fbc: fbc,
        fbp: fbp,
        link_id: link_id,
        event_time: Math.floor(Date.now() / 1000),
        event_source_url: location.href
      };
      
      const sent = sendPixelEventOnce('PageView', pageViewData);
      if (sent) RedirectState.pixelPageViewSent = true;
    }

    function sendTimeOnPageEvent() {
      RedirectState.timeOnPage = Date.now() - RedirectState.pageLoadTime;
      
      const timeData = {
        time_on_page: RedirectState.timeOnPage,
        page_title: document.title,
        page_url: location.href,
        referrer: document.referrer || null,
        user_agent: navigator.userAgent,
        language: navigator.language || 'pt-BR',
        screen_resolution: `${screen.width}x${screen.height}`,
        viewport_size: `${window.innerWidth}x${window.innerHeight}`,
        timezone: Intl.DateTimeFormat().resolvedOptions().timeZone || 'UTC',
        utm_source: utm_source,
        utm_medium: utm_medium,
        utm_campaign: utm_campaign,
        utm_content: utm_content,
        utm_term: utm_term,
        fbclid: fbclid,
        fbc: fbc,
        fbp: fbp,
        link_id: link_id,
        event_time: Math.floor(Date.now() / 1000),
        event_source_url: location.href,
        custom_data: {
          session_id: RedirectState.eventId,
          token: RedirectState.tokenHex,
          phone_target: WHATSAPP_NUMBER,
          time_category: RedirectState.timeOnPage < 3000 ? 'quick_exit' : 
                       RedirectState.timeOnPage < 10000 ? 'normal' : 'engaged'
        }
      };
      
      sendPixelEventOnce('time_on_page', timeData);
    }

    // ======== Clique/touch √∫nico (sem duplicar) ========
    window.addEventListener('pointerdown', () => {
      if (RedirectState.redirectInProgress) return;
      RedirectState.redirectInProgress = true;

      // Envia evento de tempo na p√°gina antes do clique
      sendTimeOnPageEvent();
      
      // Evento custom opcional (n√£o √© Lead) - usando sistema de controle
      if (typeof fbq !== 'undefined') {
        const eventKey = `wa_click_${RedirectState.eventId}`;
        if (!RedirectState.eventsSent.has(eventKey)) {
          const clickData = {
            internal_event_id: RedirectState.eventId,
            click_type: 'whatsapp_redirect',
            click_method: 'pointerdown',
            page_title: document.title,
            page_url: location.href,
            referrer: document.referrer || null,
            user_agent: navigator.userAgent,
            language: navigator.language || 'pt-BR',
            screen_resolution: `${screen.width}x${screen.height}`,
            viewport_size: `${window.innerWidth}x${window.innerHeight}`,
            color_depth: screen.colorDepth,
            timezone: Intl.DateTimeFormat().resolvedOptions().timeZone || 'UTC',
            utm_source: utm_source,
            utm_medium: utm_medium,
            utm_campaign: utm_campaign,
            utm_content: utm_content,
            utm_term: utm_term,
            fbclid: fbclid,
            fbc: fbc,
            fbp: fbp,
            link_id: link_id,
            event_time: Math.floor(Date.now() / 1000),
            custom_data: {
              click_source: 'whatsapp_redirect',
              click_medium: 'landing_page',
              click_campaign: utm_campaign,
              click_content: utm_content,
              click_term: utm_term,
              session_id: RedirectState.eventId,
              token: RedirectState.tokenHex,
              phone_target: WHATSAPP_NUMBER,
              message_preview: mensagemFinal.substring(0, 50) + '...',
              click_timestamp: Date.now(),
              click_position: 'center_page'
            }
          };
          
          fbq('trackCustom', 'wa_click', clickData, {
            eventID: RedirectState.eventId,
            eventSourceUrl: location.href
          });
          RedirectState.eventsSent.add(eventKey);
          console.log('üìä Pixel wa_click enviado (client).');
        }
      }

      window.location.replace(createWhatsAppURL(mensagemFinal));
    }, { once:true, passive:true });

    window.addEventListener('keydown', (e) => {
      if (e.key !== 'Enter') return;
      if (RedirectState.redirectInProgress) return;
      RedirectState.redirectInProgress = true;
      window.location.replace(createWhatsAppURL(mensagemFinal));
    }, { once:true });

    // ======== Fluxo principal ========
    (async function main(){
      console.log('üöÄ Iniciando fluxo...');
      
      // Aguarda o pixel estar pronto antes de enviar PageView
      const waitForPixel = () => {
        return new Promise((resolve) => {
          const checkPixel = () => {
            if (typeof fbq !== 'undefined') {
              resolve();
            } else {
              setTimeout(checkPixel, 50);
            }
          };
          checkPixel();
        });
      };
      
      await waitForPixel();
      
      // Envia PageView apenas uma vez no in√≠cio
      sendPixelPageViewOnce();
      
      if (isDedupe(dedupeCtxKey)) {
        console.log('üõë Dedupe por contexto ‚Äî j√° processado recentemente.');
        // Mesmo com dedupe, ainda redireciona para n√£o travar o usu√°rio
        console.log('üîÑ Redirecionando mesmo com dedupe ativo...');
      } else {
        setDedupe(dedupeCtxKey, DEDUPE_TTL_MS);
      }

      const payload = {
        event_type: 'lead_captured',
        event_id: RedirectState.eventId,
        short_token: RedirectState.tokenHex,
        link_id,
        phone_target: WHATSAPP_NUMBER,
        url: location.href,
        referrer: document.referrer || null,
        user_agent: navigator.userAgent,
        language: navigator.language || 'pt-BR',
        timezone: Intl.DateTimeFormat().resolvedOptions().timeZone || 'UTC',
        utm_source, utm_medium, utm_campaign, utm_content, utm_term,
        fbp: fbp || null,
        fbc: fbc || null,
        // IP/geo: deixe para o servidor (mais confi√°vel) ‚Äî aqui ficam nulos
        ip: null, country: null, region: null, city: null
      };

      // Tenta o webhook (CAPI) com timeout configur√°vel
      const abortCtl = new AbortController();
      const webhookTimeout = Math.min(REDIRECT_DELAY - 1000, 3000); // M√°ximo 3s, mas respeita REDIRECT_DELAY
      const softTimeout = setTimeout(() => abortCtl.abort(), webhookTimeout);

      let webhookOk = false;
      try {
        webhookOk = await sendWebhook(payload);
      } catch(_) {}
      clearTimeout(softTimeout);

      // Se o webhook falhar, manda Lead no client (1x) para n√£o perder convers√£o
      if (!webhookOk) {
        console.log('‚ö†Ô∏è Webhook falhou, enviando Lead via pixel client-side');
        sendPixelLeadOnce({
          value: 0,
          currency: 'BRL',
          content_name: 'WhatsApp Lead',
          content_category: 'Lead Generation',
          content_type: 'lead_form',
          lead_type: 'whatsapp_redirect',
          page_title: document.title,
          page_url: location.href,
          referrer: document.referrer || null,
          user_agent: navigator.userAgent,
          language: navigator.language || 'pt-BR',
          screen_resolution: `${screen.width}x${screen.height}`,
          viewport_size: `${window.innerWidth}x${window.innerHeight}`,
          color_depth: screen.colorDepth,
          timezone: Intl.DateTimeFormat().resolvedOptions().timeZone || 'UTC',
          utm_source: utm_source,
          utm_medium: utm_medium,
          utm_campaign: utm_campaign,
          utm_content: utm_content,
          utm_term: utm_term,
          fbclid: fbclid,
          fbc: fbc,
          fbp: fbp,
          link_id: link_id,
          event_time: Math.floor(Date.now() / 1000),
          event_source_url: location.href,
          custom_data: {
            lead_source: 'whatsapp_redirect',
            lead_medium: 'landing_page',
            lead_campaign: utm_campaign,
            lead_content: utm_content,
            lead_term: utm_term,
            session_id: RedirectState.eventId,
            token: RedirectState.tokenHex,
            phone_target: WHATSAPP_NUMBER,
            message_preview: mensagemFinal.substring(0, 50) + '...'
          }
        });
      } else {
        console.log('‚úÖ Webhook enviado com sucesso, Lead ser√° processado via CAPI');
      }

      // Redirect autom√°tico se o usu√°rio ainda n√£o clicou (com delay configur√°vel)
      if (!RedirectState.redirectInProgress) {
        console.log(`‚è∞ Agendando redirect autom√°tico em ${REDIRECT_DELAY}ms...`);
        setTimeout(() => {
          if (!RedirectState.redirectInProgress) {
            console.log('üöÄ Executando redirect autom√°tico...');
            // Envia evento de tempo na p√°gina antes do redirect autom√°tico
            sendTimeOnPageEvent();
            
            RedirectState.redirectInProgress = true;
            const whatsappURL = createWhatsAppURL(mensagemFinal);
            console.log('‚û°Ô∏è Redirecionando para:', whatsappURL);
            window.location.replace(whatsappURL);
          } else {
            console.log('‚ö†Ô∏è Redirect j√° em progresso, pulando...');
          }
        }, REDIRECT_DELAY);
      } else {
        console.log('‚ö†Ô∏è Redirect j√° em progresso, n√£o agendando novo...');
      }
    })();
  </script>
</body>
</html>
