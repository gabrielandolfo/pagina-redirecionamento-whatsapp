<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Redirecionando…</title>
  <style>body{font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;margin:0;display:grid;place-items:center;height:100vh;text-align:center}</style>
  <script>
    // === CONFIG ===
    const WHATSAPP_NUMBER = '5535991712235';
    const BASE_MESSAGE    = 'Olá! Quero receber os materiais!';
    const PREHOOK_URL     = 'https://webhook.servidorrrdigital.site/webhook/redirect';

    // === UTM helpers ===
    const qs = new URLSearchParams(location.search);
    const get = (k,d='') => (qs.get(k) || d);
    const slug = s => String(s||'na').toLowerCase().replace(/[^a-z0-9]+/g,'_').replace(/^_|_$/g,'');

    // === Event id simple ===
    function uuid(){
      return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => {
        const r = crypto.getRandomValues(new Uint8Array(1))[0] & 15;
        const v = c === 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
      });
    }

    // === Zero width encoder kept (token invisível no texto) ===
    function invis(hex){
      const MAP = {'0':'\u200B','1':'\u200C','2':'\u200D','3':'\u2060','4':'\u061C','5':'\u180D','6':'\u034F','7':'\u00AD','8':'\u17B4','9':'\u115F','a':'\u2061','b':'\u2062','c':'\u2063','d':'\u2064','e':'\u206A','f':'\u206F'};
      return hex.toLowerCase().replace(/[^0-9a-f]/g,'').slice(0,12).split('').map(ch=>MAP[ch]||'').join('');
    }

    // === Fire webhook (GET pixel + sendBeacon POST) ===
    function fire(payload){
      try{
        // GET pixel (no CORS ever)
        const p = new URLSearchParams();
        for (const [k,v] of Object.entries(payload)) if (v!==undefined && v!==null && v!=='') p.append(k, typeof v==='object' ? JSON.stringify(v) : String(v));
        const img = new Image();
        img.src = PREHOOK_URL + '?' + p.toString();
      }catch(e){}

      try{
        // POST sendBeacon (best-effort)
        const p2 = new URLSearchParams();
        for (const [k,v] of Object.entries(payload)) if (v!==undefined && v!==null && v!=='') p2.append(k, typeof v==='object' ? JSON.stringify(v) : String(v));
        const blob = new Blob([p2.toString()], {type:'application/x-www-form-urlencoded;charset=UTF-8'});
        navigator.sendBeacon(PREHOOK_URL, blob);
      }catch(e){}
    }

    async function start(){
      const event_id   = uuid();
      const short_token= event_id.replace(/-/g,'').slice(0,12);
      const msg        = BASE_MESSAGE + invis(short_token);

      // basic utms
      const utm_source   = slug(get('utm_source','facebook'));
      const utm_medium   = slug(get('utm_medium','paid_social'));
      const utm_campaign = slug(get('utm_campaign','mad_cpd_prospect_brazil'));
      const utm_content  = slug(get('utm_content','creative_v2_fomo'));
      const utm_term     = slug(get('utm_term','25_54_stack'));
      const fbclid       = get('fbclid','');
      const fbp          = get('_fbp','');

      const payload = {
        event_type: 'lead_captured',
        event_id,
        short_token,
        link_id: `${utm_source}_${utm_medium}_${utm_campaign}`,
        phone_target: WHATSAPP_NUMBER,
        utm_source, utm_medium, utm_campaign, utm_content, utm_term,
        ad_id: utm_content, adset_id: utm_campaign, campaign_id: utm_campaign,
        url: location.href,
        referrer: document.referrer || '',
        fbclid, fbp,
        client_timestamp: new Date().toISOString()
      };

      fire(payload);

      const wa = `https://api.whatsapp.com/send?phone=${encodeURIComponent(WHATSAPP_NUMBER)}&text=${encodeURIComponent(msg)}`;

      // Fail-safe redirects
      setTimeout(()=>{ location.href = wa; }, 900);
      setTimeout(()=>{ location.replace(wa); }, 3000);
    }

    // Kickoff ASAP without waiting other scripts
    document.addEventListener('DOMContentLoaded', start);
  </script>
</head>
<body>
  <div>
    <h1>Enviando…</h1>
    <p>Você será redirecionado ao WhatsApp automaticamente.</p>
  </div>
</body>
</html>
