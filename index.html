<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Redirecionando...</title>

  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      text-align: center; margin: 0; padding: 0; min-height: 100vh;
      display: flex; flex-direction: column; justify-content: center; align-items: center;
      background: #ffffff; color: #1a5f7a; cursor: pointer; user-select: none;
    }
    .main-message { font-size: 20px; font-weight: 500; margin: 0; padding: 20px; text-align: center; max-width: 500px; line-height: 1.4; color: #1a5f7a; }
    .loading-indicator { display: flex; align-items: center; justify-content: center; margin-bottom: 20px; }
    .loading-dot { width: 8px; height: 8px; border-radius: 50%; background-color: #00d4aa; margin: 0 4px; animation: pulse 1.5s ease-in-out infinite; }
    .loading-dot:nth-child(2) { animation-delay: 0.2s; }
    .loading-dot:nth-child(3) { animation-delay: 0.4s; }
    @keyframes pulse { 0%, 60%, 100% { opacity: 0.3; transform: scale(0.8); } 30% { opacity: 1; transform: scale(1); } }
    .redirect-text { font-size: 24px; font-weight: 600; color: #1a5f7a; margin-top: 30px; }
    .click-hint { font-size: 14px; color: #7a9ca8; margin-top: 20px; font-weight: 400; opacity: 0.8; }
  </style>
</head>
<body>
  <div class="main-message">
    <div class="loading-indicator">
      <div class="loading-dot"></div>
      <div class="loading-dot"></div>
      <div class="loading-dot"></div>
    </div>
    Carregando...
  </div>
  <div class="redirect-text">Estamos abrindo o WhatsApp</div>
  <div class="click-hint">Isso leva só 2 segundos!</div>

  <script>
    // ======== CONFIGURAÇÕES DIRETAS ========
    const META_PIXEL_ID = '1242065550945306';
    const WHATSAPP_NUMBER = '5591993921776';
    const BASE_MESSAGE = 'Olá! Quero receber os materiais! Cupom: ';
    const PREHOOK_URL = 'https://webhook.servidorrrdigital.site/webhook/redirect';
    
    // ======== PARÂMETROS DE TEMPO (HARD DEADLINE) ========
    const REDIRECT_DEADLINE_MS = 2000; // 2s fixos, independentemente de qualquer outra coisa
    const WEBHOOK_BUDGET_MS = 1200;    // janela máxima para tentar o webhook antes do redirect
    const WEBHOOK_RETRY_DELAY = 250;   // pequenos retries dentro do orçamento
    const MAX_WEBHOOK_RETRIES = 3;
    const DEDUPE_TTL_MS = 10 * 60 * 1000; // 10 minutos

    // ======== PIXEL META BASE ========
    if (window.fbq) {
      try { delete window.fbq; delete window._fbq; } catch {}
    }
    // Carrega o script do pixel sem bloquear o fluxo
    (function(){
      !function(f,b,e,v,n,t,s){if(f.fbq)return;n=f.fbq=function(){
      n.callMethod? n.callMethod.apply(n,arguments):n.queue.push(arguments)};
      if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
      n.queue=[];t=b.createElement(e);t.async=!0;
      t.src=v;s=b.getElementsByTagName(e)[0];
      s.parentNode.insertBefore(t,s)}(window, document,'script',
      'https://connect.facebook.net/en_US/fbevents.js');
    })();

    function initPixelOnce(){
      if (typeof fbq !== 'undefined' && !window.pixelInitialized) {
        try {
          fbq('init', META_PIXEL_ID);
          window.pixelInitialized = true;
          const noscript = document.createElement('noscript');
          const img = document.createElement('img');
          img.height = 1; img.width = 1; img.style.display = 'none';
          img.src = `https://www.facebook.com/tr?id=${META_PIXEL_ID}&ev=PageView&noscript=1`;
          noscript.appendChild(img);
          document.head.appendChild(noscript);
        } catch {}
      }
    }

    // ======== Utils ========
    const qp = (n) => new URLSearchParams(location.search).get(n);
    function getCookie(name){
      try {
        return document.cookie.split('; ').find(row => row.startsWith(name + '='))?.split('=')[1] || null;
      } catch { return null; }
    }
    function uuidv4(){
      return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g,c=>{
        const r = crypto.getRandomValues(new Uint8Array(1))[0] & 15;
        const v = c === 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
      });
    }
    function createWhatsAppURL(message) {
      return `https://api.whatsapp.com/send?phone=${encodeURIComponent(WHATSAPP_NUMBER)}&text=${encodeURIComponent(message)}`;
    }
    function dedupeKey({phone, utm_source, utm_campaign, fbp}){
      return `redir:${phone}:${utm_source||'na'}:${utm_campaign||'na'}:${fbp||'na'}`;
    }
    function setDedupe(key, ttlMs){ try { localStorage.setItem(key, String(Date.now() + ttlMs)); } catch {} }
    function isDedupe(key){
      try {
        const until = Number(localStorage.getItem(key) || 0);
        return until && Date.now() < until;
      } catch {}
      return false;
    }

    // ======== IDs, UTMs, cookies Meta ========
    const fbclid = qp('fbclid');
    const fbc = fbclid ? `fb.1.${Math.floor(Date.now()/1000)}.${fbclid}` : null;
    const fbp = getCookie('_fbp');
    const utm_source   = (qp('utm_source')   || 'organic').toLowerCase();
    const utm_medium   = (qp('utm_medium')   || 'direct').toLowerCase();
    const utm_campaign = (qp('utm_campaign') || 'na').toLowerCase();
    const utm_content  = (qp('utm_content')  || 'na').toLowerCase();
    const utm_term     = (qp('utm_term')     || 'na').toLowerCase();
    const link_id = `${utm_source}_${utm_medium}_${utm_campaign}`;

    // ======== Estado global e token ========
    const RedirectState = {
      eventId: uuidv4(),
      tokenHex: null,
      redirectInProgress: false,
      pixelLeadSent: false,
      pixelPageViewSent: false,
      webhookSentOk: false,
      eventsSent: new Set(),
      pageLoadTime: performance.now(),
      timeOnPage: 0
    };
    RedirectState.tokenHex = RedirectState.eventId.replace(/-/g,'').slice(0,8);
    const mensagemFinal = `${BASE_MESSAGE}${RedirectState.tokenHex}`;
    const dedupeCtxKey = dedupeKey({phone: WHATSAPP_NUMBER, utm_source, utm_campaign, fbp});

    // ======== Pixel helpers (não bloqueiam redirect) ========
    function sendPixelEventOnce(eventName, payload, eventId = null) {
      const eventKey = `${eventName}_${eventId || RedirectState.eventId}`;
      if (RedirectState.eventsSent.has(eventKey)) return false;
      if (typeof fbq === 'undefined') return false;
      try {
        fbq('track', eventName, payload, { eventID: eventId || RedirectState.eventId, eventSourceUrl: location.href });
        RedirectState.eventsSent.add(eventKey);
        return true;
      } catch { return false; }
    }
    function sendPixelLeadOnce(payload){
      if (RedirectState.pixelLeadSent) return;
      const sent = sendPixelEventOnce('Lead', payload);
      if (sent) RedirectState.pixelLeadSent = true;
    }
    function sendPixelPageViewOnce() {
      if (RedirectState.pixelPageViewSent) return;
      const pageViewData = {
        content_name: 'WhatsApp Redirect Page',
        content_category: 'Lead Generation',
        content_type: 'landing_page',
        page_title: document.title,
        page_url: location.href,
        referrer: document.referrer || null,
        user_agent: navigator.userAgent,
        language: navigator.language || 'pt-BR',
        screen_resolution: `${screen.width}x${screen.height}`,
        viewport_size: `${window.innerWidth}x${window.innerHeight}`,
        color_depth: screen.colorDepth,
        timezone: Intl.DateTimeFormat().resolvedOptions().timeZone || 'UTC',
        utm_source, utm_medium, utm_campaign, utm_content, utm_term,
        fbclid, fbc, fbp, link_id,
        event_time: Math.floor(Date.now() / 1000),
        event_source_url: location.href
      };
      const sent = sendPixelEventOnce('PageView', pageViewData);
      if (sent) RedirectState.pixelPageViewSent = true;
    }
    function sendTimeOnPageEvent() {
      RedirectState.timeOnPage = performance.now() - RedirectState.pageLoadTime;
      const timeData = {
        time_on_page: Math.round(RedirectState.timeOnPage),
        page_title: document.title,
        page_url: location.href,
        referrer: document.referrer || null,
        user_agent: navigator.userAgent,
        language: navigator.language || 'pt-BR',
        screen_resolution: `${screen.width}x${screen.height}`,
        viewport_size: `${window.innerWidth}x${window.innerHeight}`,
        timezone: Intl.DateTimeFormat().resolvedOptions().timeZone || 'UTC',
        utm_source, utm_medium, utm_campaign, utm_content, utm_term,
        fbclid, fbc, fbp, link_id,
        event_time: Math.floor(Date.now() / 1000),
        event_source_url: location.href,
        custom_data: {
          session_id: RedirectState.eventId,
          token: RedirectState.tokenHex,
          phone_target: WHATSAPP_NUMBER,
          time_category: RedirectState.timeOnPage < 3000 ? 'quick_exit' : 
                         RedirectState.timeOnPage < 10000 ? 'normal' : 'engaged'
        }
      };
      sendPixelEventOnce('time_on_page', timeData);
    }

    // ======== Webhook (fire-and-forget dentro de um orçamento) ========
    async function tryWebhookWithinBudget(payload, budgetMs){
      // usa AbortController + fetch keepalive para não bloquear o redirect/unload
      const controller = new AbortController();
      const timer = setTimeout(() => controller.abort('timeout'), budgetMs);

      try {
        const res = await fetch(PREHOOK_URL, {
          method: 'POST',
          headers: {'Content-Type':'application/json','Accept':'application/json'},
          body: JSON.stringify(payload),
          keepalive: true,
          signal: controller.signal
        });
        clearTimeout(timer);
        if (res.ok) return true;
      } catch(_) {
        clearTimeout(timer);
      }
      return false;
    }

    // ======== Interações do usuário (podem antecipar redirect) ========
    function goNow(){
      if (RedirectState.redirectInProgress) return;
      sendTimeOnPageEvent(); // tenta antes de sair
      RedirectState.redirectInProgress = true;
      window.location.replace(createWhatsAppURL(mensagemFinal));
    }
    window.addEventListener('pointerdown', goNow, { once:true, passive:true });
    window.addEventListener('keydown', (e) => { if (e.key === 'Enter') goNow(); }, { once:true });

    // ======== Fluxo principal com DEADLINE DE 2s ========
    (function main(){
      const deadlineAt = performance.now() + REDIRECT_DEADLINE_MS;

      // 1) Agenda redirect duro para 2s (independente de qualquer coisa)
      setTimeout(() => {
        if (!RedirectState.redirectInProgress) goNow();
      }, REDIRECT_DEADLINE_MS);

      // 2) Inicia Pixel assim que possível (não bloqueia)
      //    Tenta a cada ~50ms até o deadline.
      (function spinInitPixel(){
        if (performance.now() >= deadlineAt) return;
        initPixelOnce();
        if (!window.pixelInitialized) setTimeout(spinInitPixel, 50);
      })();

      // 3) PageView não-bloqueante (quando fbq estiver pronto)
      (function spinPV(){
        if (performance.now() >= deadlineAt) return;
        if (typeof fbq !== 'undefined') {
          sendPixelPageViewOnce();
        } else {
          setTimeout(spinPV, 60);
        }
      })();

      // 4) Dedupe de contexto (não crítico)
      if (!isDedupe(dedupeCtxKey)) setDedupe(dedupeCtxKey, DEDUPE_TTL_MS);

      // 5) Dispara webhook em background dentro do orçamento total (1.2s)
      (async () => {
        const payload = {
          event_type: 'lead_captured',
          event_id: RedirectState.eventId,
          short_token: RedirectState.tokenHex,
          link_id,
          phone_target: WHATSAPP_NUMBER,
          url: location.href,
          referrer: document.referrer || null,
          user_agent: navigator.userAgent,
          language: navigator.language || 'pt-BR',
          timezone: Intl.DateTimeFormat().resolvedOptions().timeZone || 'UTC',
          utm_source, utm_medium, utm_campaign, utm_content, utm_term,
          fbp: fbp || null,
          fbc: fbc || null,
          ip: null, country: null, region: null, city: null
        };

        let ok = await tryWebhookWithinBudget(payload, WEBHOOK_BUDGET_MS);
        let tries = 1;
        while (!ok && tries < MAX_WEBHOOK_RETRIES && (performance.now() + WEBHOOK_RETRY_DELAY) < deadlineAt) {
          await new Promise(r => setTimeout(r, WEBHOOK_RETRY_DELAY));
          ok = await tryWebhookWithinBudget(payload, Math.max(80, deadlineAt - performance.now() - 50));
          tries++;
        }
        if (!ok) {
          // fallback client-side (não bloqueia e pode rodar após redirect)
          const fallback = () => sendPixelLeadOnce({
              value: 0,
              currency: 'BRL',
              content_name: 'WhatsApp Lead',
              content_category: 'Lead Generation',
              content_type: 'lead_form',
              lead_type: 'whatsapp_redirect',
              page_title: document.title,
              page_url: location.href,
              referrer: document.referrer || null,
              user_agent: navigator.userAgent,
              language: navigator.language || 'pt-BR',
              screen_resolution: `${screen.width}x${screen.height}`,
              viewport_size: `${window.innerWidth}x${window.innerHeight}`,
              color_depth: screen.colorDepth,
              timezone: Intl.DateTimeFormat().resolvedOptions().timeZone || 'UTC',
              utm_source, utm_medium, utm_campaign, utm_content, utm_term,
              fbclid, fbc, fbp, link_id,
              event_time: Math.floor(Date.now() / 1000),
              event_source_url: location.href,
              custom_data: {
                lead_source: 'whatsapp_redirect',
                lead_medium: 'landing_page',
                lead_campaign: utm_campaign,
                lead_content: utm_content,
                lead_term: utm_term,
                session_id: RedirectState.eventId,
                token: RedirectState.tokenHex,
                phone_target: WHATSAPP_NUMBER,
                message_preview: mensagemFinal.substring(0, 50) + '...'
              }
          });
          // tenta mandar antes do unload
          try { fallback(); } catch {}
          // também tenta no beforeunload (caso fbq só fique pronto bem no final)
          window.addEventListener('beforeunload', () => { try { fallback(); } catch {} }, { once:true });
        }
      })();
    })();
  </script>
</body>
</html>
